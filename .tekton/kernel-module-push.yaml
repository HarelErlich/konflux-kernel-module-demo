apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  annotations:
    build.appstudio.openshift.io/repo: https://github.com/HarelErlich/konflux-kernel-module-demo?rev={{revision}}
    build.appstudio.redhat.com/commit_sha: '{{revision}}'
    build.appstudio.redhat.com/target_branch: '{{target_branch}}'
    pipelinesascode.tekton.dev/cancel-in-progress: "false"
    pipelinesascode.tekton.dev/max-keep-runs: "3"
    # Run on push to main only
    pipelinesascode.tekton.dev/on-cel-expression: event == "push" && target_branch == "main"
  labels:
    appstudio.openshift.io/application: kernel-module-app
    appstudio.openshift.io/component: kernel-module
    pipelines.appstudio.openshift.io/type: build
  name: kernel-module-on-push
  namespace: rh-ee-herlich-tenant
spec:
  params:
    - name: git-url
      value: '{{source_url}}'
    - name: revision
      value: '{{revision}}'
    - name: output-image
      # Push built image to your Quay repo tagged by commit SHA
      value: quay.io/herlich/kernel-module:{{revision}}
    - name: dockerfile
      value: Dockerfile
    - name: path-context
      value: .
    # Disable optional checks/scans to avoid missing catalog tasks
    - name: skip-checks
      value: "true"
    # Leave hermetic/prefetch empty (non-hermetic build)
    - name: hermetic
      value: "false"
    - name: prefetch-input
      value: ""
    - name: image-expires-after
      value: ""  # no temporary expiration
    - name: build-source-image
      value: "false"
    - name: build-image-index
      value: "false"
    - name: build-args
      value: []
    - name: build-args-file
      value: ""
    - name: privileged-nested
      value: "false"
  # Keep it simple: clone -> build -> (optional) index
  pipelineSpec:
    description: |
      Minimal pipeline to build and push an image using buildah with Trusted Artifacts.
      Prefetch and security scan tasks are disabled for simplicity.
    params:
      - name: git-url
        type: string
        description: Source Repository URL
      - name: revision
        type: string
        description: Revision of the Source Repository
        default: ""
      - name: output-image
        type: string
        description: Fully Qualified Output Image
      - name: path-context
        type: string
        description: Build context path
        default: .
      - name: dockerfile
        type: string
        description: Path to the Dockerfile inside context
        default: Dockerfile
      - name: rebuild
        type: string
        description: Force rebuild image
        default: "false"
      - name: skip-checks
        type: string
        description: Skip checks against built image
        default: "true"
      - name: hermetic
        type: string
        description: Execute the build with network isolation
        default: "false"
      - name: prefetch-input
        type: string
        description: Build dependencies to be prefetched
        default: ""
      - name: image-expires-after
        type: string
        description: Optional temporary tag expiration window
        default: ""
      - name: build-source-image
        type: string
        description: Build a source image
        default: "false"
      - name: build-image-index
        type: string
        description: Add built image into an OCI image index
        default: "false"
      - name: build-args
        type: array
        description: Array of --build-arg values ("arg=value" strings) for buildah
        default: []
      - name: build-args-file
        type: string
        description: Path to a file with build arguments for buildah
        default: ""
      - name: privileged-nested
        type: string
        description: Enable privileged mode for remote VMs only
        default: "false"
    results:
      # Publish results from build-image-index if present, else from build step
      - name: IMAGE_URL
        description: Image URL
        value: $(tasks.build-image-index.results.IMAGE_URL)
      - name: IMAGE_DIGEST
        description: Image digest
        value: $(tasks.build-image-index.results.IMAGE_DIGEST)

    workspaces:
      - name: git-auth
        optional: true
  taskRunTemplate:
    serviceAccountName: build-pipeline-kernel-module
  workspaces:
    - name: git-auth
      secret:
        secretName: '{{ git_auth_secret }}'